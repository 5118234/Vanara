<html><head><meta http-equiv="X-UA-Compatible" content="IE=edge" /><link rel="shortcut icon" href="../icons/favicon.ico" /><link rel="stylesheet" type="text/css" href="../styles/branding.css" /><link rel="stylesheet" type="text/css" href="../styles/branding-en-US.css" /><script type="text/javascript" src="../scripts/branding.js"> </script><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>VirtDisk.CompactVirtualDisk Method (SafeFileHandle, VirtDisk.COMPACT_VIRTUAL_DISK_FLAG, VirtDisk.COMPACT_VIRTUAL_DISK_PARAMETERS, IntPtr)</title><meta name="Language" content="en-us" /><meta name="Microsoft.Help.Id" content="M:Vanara.PInvoke.VirtDisk.CompactVirtualDisk(Microsoft.Win32.SafeHandles.SafeFileHandle,Vanara.PInvoke.VirtDisk.COMPACT_VIRTUAL_DISK_FLAG,Vanara.PInvoke.VirtDisk.COMPACT_VIRTUAL_DISK_PARAMETERS@,System.IntPtr)" /><meta name="Description" content="Reduces the size of a virtual hard disk (VHD) backing store file." /><meta name="Microsoft.Help.ContentType" content="Reference" /><meta name="BrandingAware" content="true" /><meta name="container" content="Vanara.PInvoke" /><meta name="file" content="85010339-9205-0fc9-65ec-ad2084ffa108" /><meta name="guid" content="85010339-9205-0fc9-65ec-ad2084ffa108" /><link rel="stylesheet" type="text/css" href="../styles/branding-Website.css" /><script type="text/javascript" src="../scripts/jquery-1.11.0.min.js"></script><script type="text/javascript" src="../scripts/branding-Website.js"></script><script type="text/javascript" src="../scripts/clipboard.min.js"></script></head><body onload="OnLoad('cs')"><input type="hidden" id="userDataCache" class="userDataStyle" /><div class="pageHeader" id="PageHeader">Vanara API Documentation<form id="SearchForm" method="get" action="#" onsubmit="javascript:TransferToSearchPage(); return false;"><input id="SearchTextBox" type="text" maxlength="200" /><button id="SearchButton" type="submit"></button></form></div><div class="pageBody"><div class="leftNav" id="leftNav"><div id="tocNav"><div class="toclevel0" data-toclevel="0"><a class="tocCollapsed" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="d22522ce-4106-42b2-81eb-cb37a0f36df8.htm" title="Vanara API Documentation" tocid="roottoc">Vanara API Documentation</a></div><div class="toclevel0" data-toclevel="0"><a class="tocCollapsed" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="c0250011-c1b9-bc9a-b501-96a9795f44a5.htm" title="Vanara.PInvoke" tocid="c0250011-c1b9-bc9a-b501-96a9795f44a5">Vanara.PInvoke</a></div><div class="toclevel0" data-toclevel="0"><a class="tocCollapsed" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="cd7419c7-8b13-7877-9c81-7ab1104f0af8.htm" title="VirtDisk Class" tocid="cd7419c7-8b13-7877-9c81-7ab1104f0af8">VirtDisk Class</a></div><div class="toclevel0" data-toclevel="0"><a class="tocCollapsed" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="428b03e5-69cd-36ea-d91d-868166aac0bb.htm" title="VirtDisk Methods" tocid="428b03e5-69cd-36ea-d91d-868166aac0bb">VirtDisk Methods</a></div><div class="toclevel1" data-toclevel="1" data-childrenloaded="true"><a class="tocExpanded" onclick="javascript: Toggle(this);" href="#!" /><a data-tochassubtree="true" href="88f6cf75-886f-ccbd-ad12-87e185255042.htm" title="CompactVirtualDisk Method " tocid="88f6cf75-886f-ccbd-ad12-87e185255042">CompactVirtualDisk Method </a></div><div class="toclevel2 current" data-toclevel="2"><a data-tochassubtree="false" href="85010339-9205-0fc9-65ec-ad2084ffa108.htm" title="CompactVirtualDisk Method (SafeFileHandle, VirtDisk.COMPACT_VIRTUAL_DISK_FLAG, VirtDisk.COMPACT_VIRTUAL_DISK_PARAMETERS, IntPtr)" tocid="85010339-9205-0fc9-65ec-ad2084ffa108">CompactVirtualDisk Method (SafeFileHandle, VirtDisk.COMPACT_VIRTUAL_DISK_FLAG, VirtDisk.COMPACT_VIRTUAL_DISK_PARAMETERS, IntPtr)</a></div><div class="toclevel2" data-toclevel="2"><a data-tochassubtree="false" href="f27b46f1-ab53-c689-e830-30dc9e9de8b5.htm" title="CompactVirtualDisk Method (SafeFileHandle, VirtDisk.COMPACT_VIRTUAL_DISK_FLAG, VirtDisk.COMPACT_VIRTUAL_DISK_PARAMETERS, NativeOverlapped)" tocid="f27b46f1-ab53-c689-e830-30dc9e9de8b5">CompactVirtualDisk Method (SafeFileHandle, VirtDisk.COMPACT_VIRTUAL_DISK_FLAG, VirtDisk.COMPACT_VIRTUAL_DISK_PARAMETERS, NativeOverlapped)</a></div></div><div id="tocResizableEW" onmousedown="OnMouseDown(event);"></div><div id="TocResize" class="tocResize"><img id="ResizeImageIncrease" src="../icons/TocOpen.gif" onclick="OnIncreaseToc()" alt="Click or drag to resize" title="Click or drag to resize" /><img id="ResizeImageReset" src="../icons/TocClose.gif" style="display:none" onclick="OnResetToc()" alt="Click or drag to resize" title="Click or drag to resize" /></div></div><div class="topicContent" id="TopicContent"><table class="titleTable"><tr><td class="logoColumn"><img src="../icons/Help.png" /></td><td class="titleColumn"><h1>VirtDisk<span id="LSTC59DADBE_0"></span><script type="text/javascript">AddLanguageSpecificTextSet("LSTC59DADBE_0?cpp=::|nu=.");</script>CompactVirtualDisk Method (SafeFileHandle, VirtDisk<span id="LSTC59DADBE_1"></span><script type="text/javascript">AddLanguageSpecificTextSet("LSTC59DADBE_1?cpp=::|nu=.");</script>COMPACT_VIRTUAL_DISK_FLAG, VirtDisk<span id="LSTC59DADBE_2"></span><script type="text/javascript">AddLanguageSpecificTextSet("LSTC59DADBE_2?cpp=::|nu=.");</script>COMPACT_VIRTUAL_DISK_PARAMETERS<span id="LSTC59DADBE_3"></span><script type="text/javascript">AddLanguageSpecificTextSet("LSTC59DADBE_3?cpp=%");</script>, IntPtr)</h1></td></tr></table><span class="introStyle"></span> <div class="summary">Reduces the size of a virtual hard disk (VHD) backing store file.</div><p> </p>
    <strong>Namespace:</strong> 
   <a href="c0250011-c1b9-bc9a-b501-96a9795f44a5.htm">Vanara.PInvoke</a><br />
    <strong>Assembly:</strong>
   Vanara.PInvoke.VirtDisk (in Vanara.PInvoke.VirtDisk.dll) Version: 1.0.2<div class="collapsibleAreaRegion"><span class="collapsibleRegionTitle" onclick="SectionExpandCollapse('ID1RB')" onkeypress="SectionExpandCollapse_CheckKey('ID1RB', event)" tabindex="0"><img id="ID1RBToggle" class="collapseToggle" src="../icons/SectionExpanded.png" />Syntax</span></div><div id="ID1RBSection" class="collapsibleSection"><div class="codeSnippetContainer"><div class="codeSnippetContainerTabs"><div id="ID0EBCA_tab1" class="codeSnippetContainerTab"><a href="#" onclick="javascript:ChangeTab('ID0EBCA','cs','1','2');return false;">C#</a></div><div id="ID0EBCA_tab2" class="codeSnippetContainerTab"><a href="#" onclick="javascript:ChangeTab('ID0EBCA','vb','2','2');return false;">VB</a></div></div><div class="codeSnippetContainerCodeContainer"><div class="codeSnippetToolBar"><div class="codeSnippetToolBarText"><a id="ID0EBCA_copyCode" href="#" class="copyCodeSnippet" onclick="javascript:CopyToClipboard('ID0EBCA');return false;" title="Copy">Copy</a></div></div><div id="ID0EBCA_code_Div1" class="codeSnippetContainerCode" style="display: block"><pre xml:space="preserve"><span class="keyword">public</span> <span class="keyword">static</span> <span class="identifier">Win32Error</span> <span class="identifier">CompactVirtualDisk</span>(
	<span class="identifier">SafeFileHandle</span> <span class="parameter">VirtualDiskHandle</span>,
	<span class="identifier">VirtDisk<span id="LSTC59DADBE_4"></span><script type="text/javascript">AddLanguageSpecificTextSet("LSTC59DADBE_4?cs=.|vb=.|cpp=::|nu=.|fs=.");</script>COMPACT_VIRTUAL_DISK_FLAG</span> <span class="parameter">Flags</span>,
	<span class="keyword">ref</span> <span class="identifier">VirtDisk<span id="LSTC59DADBE_5"></span><script type="text/javascript">AddLanguageSpecificTextSet("LSTC59DADBE_5?cs=.|vb=.|cpp=::|nu=.|fs=.");</script>COMPACT_VIRTUAL_DISK_PARAMETERS</span> <span class="parameter">Parameters</span>,
	<span class="identifier">IntPtr</span> <span class="parameter">Overlapped</span>
)</pre></div><div id="ID0EBCA_code_Div2" class="codeSnippetContainerCode" style="display: none"><pre xml:space="preserve"><span class="keyword">Public</span> <span class="keyword">Shared</span> <span class="keyword">Function</span> <span class="identifier">CompactVirtualDisk</span> ( 
	<span class="parameter">VirtualDiskHandle</span> <span class="keyword">As</span> <span class="identifier">SafeFileHandle</span>,
	<span class="parameter">Flags</span> <span class="keyword">As</span> <span class="identifier">VirtDisk<span id="LSTC59DADBE_6"></span><script type="text/javascript">AddLanguageSpecificTextSet("LSTC59DADBE_6?cs=.|vb=.|cpp=::|nu=.|fs=.");</script>COMPACT_VIRTUAL_DISK_FLAG</span>,
	<span class="keyword">ByRef</span> <span class="parameter">Parameters</span> <span class="keyword">As</span> <span class="identifier">VirtDisk<span id="LSTC59DADBE_7"></span><script type="text/javascript">AddLanguageSpecificTextSet("LSTC59DADBE_7?cs=.|vb=.|cpp=::|nu=.|fs=.");</script>COMPACT_VIRTUAL_DISK_PARAMETERS</span>,
	<span class="parameter">Overlapped</span> <span class="keyword">As</span> <span class="identifier">IntPtr</span>
) <span class="keyword">As</span> <span class="identifier">Win32Error</span></pre></div></div></div><script type="text/javascript">AddLanguageTabSet("ID0EBCA");</script><h4 class="subHeading">Parameters</h4><dl><dt><span class="parameter">VirtualDiskHandle</span></dt><dd>Type: <a href="http://msdn2.microsoft.com/en-us/library/3y85x3e7" target="_blank">Microsoft.Win32.SafeHandles<span id="LSTC59DADBE_8"></span><script type="text/javascript">AddLanguageSpecificTextSet("LSTC59DADBE_8?cs=.|vb=.|cpp=::|nu=.|fs=.");</script>SafeFileHandle</a><br />
            A handle to the open virtual disk, which must have been opened using the VIRTUAL_DISK_ACCESS_METAOPS flag in the VirtualDiskAccessMask parameter
            passed to OpenVirtualDisk. For information on how to open a virtual disk, see the OpenVirtualDisk function.
            </dd><dt><span class="parameter">Flags</span></dt><dd>Type: <a href="7f622e9b-3346-e95d-eb39-d24965761b99.htm">Vanara.PInvoke<span id="LSTC59DADBE_9"></span><script type="text/javascript">AddLanguageSpecificTextSet("LSTC59DADBE_9?cs=.|vb=.|cpp=::|nu=.|fs=.");</script>VirtDisk<span id="LSTC59DADBE_10"></span><script type="text/javascript">AddLanguageSpecificTextSet("LSTC59DADBE_10?cs=.|vb=.|cpp=::|nu=.|fs=.");</script>COMPACT_VIRTUAL_DISK_FLAG</a><br />Must be the COMPACT_VIRTUAL_DISK_FLAG_NONE value (0) of the COMPACT_VIRTUAL_DISK_FLAG enumeration.</dd><dt><span class="parameter">Parameters</span></dt><dd>Type: <a href="a1e5350d-3adc-ab26-db58-1dc3bb7db568.htm">Vanara.PInvoke<span id="LSTC59DADBE_11"></span><script type="text/javascript">AddLanguageSpecificTextSet("LSTC59DADBE_11?cs=.|vb=.|cpp=::|nu=.|fs=.");</script>VirtDisk<span id="LSTC59DADBE_12"></span><script type="text/javascript">AddLanguageSpecificTextSet("LSTC59DADBE_12?cs=.|vb=.|cpp=::|nu=.|fs=.");</script>COMPACT_VIRTUAL_DISK_PARAMETERS</a><span id="LSTC59DADBE_13"></span><script type="text/javascript">AddLanguageSpecificTextSet("LSTC59DADBE_13?cpp=%");</script><br />A optional pointer to a valid COMPACT_VIRTUAL_DISK_PARAMETERS structure that contains compaction parameter data.</dd><dt><span class="parameter">Overlapped</span></dt><dd>Type: <a href="http://msdn2.microsoft.com/en-us/library/5he14kz8" target="_blank">System<span id="LSTC59DADBE_14"></span><script type="text/javascript">AddLanguageSpecificTextSet("LSTC59DADBE_14?cs=.|vb=.|cpp=::|nu=.|fs=.");</script>IntPtr</a><br />An optional pointer to a valid OVERLAPPED structure if asynchronous operation is desired.</dd></dl><h4 class="subHeading">Return Value</h4>Type: <a href="08c41376-0893-e74a-adcf-6b5194603d48.htm">Win32Error</a><br />
            If the function succeeds, the return value is ERROR_SUCCESS. If the function fails, the return value is an error code. For more information, see
            System Error Codes.
            </div><div class="collapsibleAreaRegion"><span class="collapsibleRegionTitle" onclick="SectionExpandCollapse('ID2RB')" onkeypress="SectionExpandCollapse_CheckKey('ID2RB', event)" tabindex="0"><img id="ID2RBToggle" class="collapseToggle" src="../icons/SectionExpanded.png" />Remarks</span></div><div id="ID2RBSection" class="collapsibleSection">
            Compaction can be run only on a virtual disk that is dynamically expandable or differencing.
            <p>There are two different types of compaction.</p><ul><li>
            The first type, file-system-aware compaction, uses the NTFS file system to determine free space. This is done by attaching the VHD as a read-only
            device by including the VIRTUAL_DISK_ACCESS_METAOPS and VIRTUAL_DISK_ACCESS_ATTACH_RO flags in the VirtualDiskAccessMask parameter passed to
            OpenVirtualDisk, attaching the VHD by calling AttachVirtualDisk, and while the VHD is attached calling CompactVirtualDisk. Detaching the VHD before
            compaction is done can cause compaction to return failure before it is done (similar to cancellation of compaction).
            </li><li>
            The second type, file-system-agnostic compaction, does not involve the file system but only looks for VHD blocks filled entirely with zeros (0). This
            is done by including the VIRTUAL_DISK_ACCESS_METAOPS flag in the VirtualDiskAccessMask parameter passed to OpenVirtualDisk, and calling CompactVirtualDisk.
            </li></ul><p>
            File-system-aware compaction is the most efficient compaction type but using first the file-system-aware compaction followed by the
            file-system-agnostic compaction will produce the smallest VHD.
            </p><p>
            A compaction operation on a virtual disk can be safely interrupted and re-run later. Re-opening a virtual disk file that has been interrupted may
            result in the reduction of a virtual disk file's size at the time of opening.
            </p><p>Compaction can be CPU-intensive and/or I/O-intensive, depending on how large the virtual disk is and how many blocks require movement.</p><p>The CompactVirtualDisk function runs on the virtual disk in the same security context as the caller.</p></div><div class="collapsibleAreaRegion" id="seeAlsoSection"><span class="collapsibleRegionTitle" onclick="SectionExpandCollapse('ID3RB')" onkeypress="SectionExpandCollapse_CheckKey('ID3RB', event)" tabindex="0"><img id="ID3RBToggle" class="collapseToggle" src="../icons/SectionExpanded.png" />See Also</span></div><div id="ID3RBSection" class="collapsibleSection"><h4 class="subHeading">Reference</h4><div class="seeAlsoStyle"><a href="cd7419c7-8b13-7877-9c81-7ab1104f0af8.htm">VirtDisk Class</a></div><div class="seeAlsoStyle"><a href="88f6cf75-886f-ccbd-ad12-87e185255042.htm">CompactVirtualDisk Overload</a></div><div class="seeAlsoStyle"><a href="c0250011-c1b9-bc9a-b501-96a9795f44a5.htm">Vanara.PInvoke Namespace</a></div></div></div></div><div id="pageFooter" class="pageFooter"> </div></body></html>